name: Build and Deploy

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        edition: [standalone, flipper]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PlatformIO
        run: |
          python -m pip install --upgrade pip
          pip install platformio

      - name: Build ${{ matrix.edition }} edition
        run: pio run -e ${{ matrix.edition }}

      - name: Prepare binary
        run: |
          mkdir -p bin
          cp .pio/build/${{ matrix.edition }}/firmware.bin bin/evilportal-${{ matrix.edition }}.bin
          echo "Built evilportal-${{ matrix.edition }}.bin"
          ls -la bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ matrix.edition }}
          path: bin/evilportal-${{ matrix.edition }}.bin

  deploy-pages:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download standalone firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-standalone
          path: firmware/

      - name: Download flipper firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-flipper
          path: firmware/

      - name: Prepare Pages content
        run: |
          mkdir -p public
          cp firmware/*.bin public/
          cp webflasher/index.html public/
          cp webflasher/manifest-standalone.json public/
          cp webflasher/manifest-flipper.json public/
          echo "=== Pages content ==="
          ls -la public/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
      - name: Download standalone firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-standalone
          path: release/

      - name: Download flipper firmware
        uses: actions/download-artifact@v4
        with:
          name: firmware-flipper
          path: release/

      - name: Prepare release files
        run: |
          VERSION="${{ github.ref_name }}"
          cd release
          cp evilportal-standalone.bin "evilportal-standalone-${VERSION}.bin"
          cp evilportal-flipper.bin "evilportal-flipper-${VERSION}.bin"
          ls -la

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Evil Portal Studio ${{ github.ref_name }}
          body: |
            ## üé≠ Evil Portal Studio ${{ github.ref_name }}

            ### üì¶ Downloads

            | Edition | Description |
            |---------|-------------|
            | **evilportal-standalone.bin** | üî∑ Standalone - Independent operation |
            | **evilportal-flipper.bin** | üü† Flipper Edition - Flipper Zero integration |

            ### üåê Web Flasher

            Flash directly from your browser: **[Open Web Flasher](https://roozea.github.io/esp32-captive-portal/)**

            Default credentials: `admin` / `admin`
          files: |
            release/evilportal-standalone.bin
            release/evilportal-flipper.bin
            release/evilportal-standalone-${{ github.ref_name }}.bin
            release/evilportal-flipper-${{ github.ref_name }}.bin
          draft: false
          prerelease: false
